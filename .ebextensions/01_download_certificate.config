files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_download_certificate.sh":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/bin/bash
      set -e
      
      # Create directory if it doesn't exist
      mkdir -p /var/app/current/src/main/resources
      
      # Function to download certificate
      download_certificate() {
        aws ssm get-parameter \
          --name "/cassandra/AmazonRootCA1.pem" \
          --with-decryption \
          --region eu-north-1 \
          --query "Parameter.Value" \
          --output text > /var/app/current/src/main/resources/AmazonRootCA1.pem
      }
      
      # Try to download certificate with retries
      max_retries=5
      retry_count=0
      while [ $retry_count -lt $max_retries ]; do
        if download_certificate; then
          # Verify the certificate was downloaded and has content
          if [ -s /var/app/current/src/main/resources/AmazonRootCA1.pem ]; then
            echo "Certificate downloaded successfully"
            break
          fi
        fi
        retry_count=$((retry_count + 1))
        if [ $retry_count -lt $max_retries ]; then
          echo "Retry $retry_count of $max_retries..."
          sleep 5
        fi
      done
      
      # Final verification
      if [ ! -s /var/app/current/src/main/resources/AmazonRootCA1.pem ]; then
        echo "Failed to download certificate after $max_retries attempts"
        exit 1
      fi
      
      # Set proper permissions
      chown webapp:webapp /var/app/current/src/main/resources/AmazonRootCA1.pem
      chmod 600 /var/app/current/src/main/resources/AmazonRootCA1.pem
      
      # Create a flag file to indicate certificate is ready
      touch /var/app/current/src/main/resources/.certificate_ready
      chown webapp:webapp /var/app/current/src/main/resources/.certificate_ready
      chmod 644 /var/app/current/src/main/resources/.certificate_ready

commands:
  01_verify_certificate:
    command: |
      if [ ! -f /var/app/current/src/main/resources/AmazonRootCA1.pem ] || [ ! -s /var/app/current/src/main/resources/AmazonRootCA1.pem ]; then
        echo "Certificate not found or empty after deployment"
        exit 1
      fi
    ignoreErrors: false 