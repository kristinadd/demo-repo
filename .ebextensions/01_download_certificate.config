files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_download_certificate.sh":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/bin/bash
      set -e
      
      # Create directory if it doesn't exist
      mkdir -p /var/app/current/src/main/resources
      
      # Download certificate from Parameter Store
      aws ssm get-parameter \
        --name "/cassandra/AmazonRootCA1.pem" \
        --with-decryption \
        --region eu-north-1 \
        --query "Parameter.Value" \
        --output text > /var/app/current/src/main/resources/AmazonRootCA1.pem
      
      # Set proper permissions
      chown webapp:webapp /var/app/current/src/main/resources/AmazonRootCA1.pem
      chmod 600 /var/app/current/src/main/resources/AmazonRootCA1.pem
      
      # Verify the certificate was downloaded
      if [ ! -f /var/app/current/src/main/resources/AmazonRootCA1.pem ]; then
        echo "Failed to download certificate"
        exit 1
      fi

commands:
  01_verify_certificate:
    command: |
      if [ ! -f /var/app/current/src/main/resources/AmazonRootCA1.pem ]; then
        echo "Certificate not found after deployment"
        exit 1
      fi
    ignoreErrors: false 